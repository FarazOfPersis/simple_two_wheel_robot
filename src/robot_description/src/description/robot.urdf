<?xml version="1.0"?>
<robot name="diff_drive_robot">

  <!-- ========================= -->
  <!--       BASE LINK           -->
  <!-- ========================= -->
  <link name="base_link">
    <visual>
      <geometry>
        <cylinder radius="0.3" length="0.1"/>
      </geometry>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <material name="blue">
        <color rgba="0.0 0.3 0.8 1.0"/>
      </material>
    </visual>

    <collision>
      <geometry>
        <cylinder radius="0.3" length="0.1"/>
      </geometry>
    </collision>

    <inertial>
      <mass value="10"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.2" iyy="0.2" izz="0.2"
               ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </link>

  <!-- ========================= -->
  <!--       LEFT WHEEL          -->
  <!-- ========================= -->
  <link name="left_wheel_link">
    <visual>
      <geometry>
        <cylinder radius="0.1" length="0.1"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <material name="black">
        <color rgba="0.1 0.1 0.1 1.0"/>
      </material>
    </visual>

    <collision>
      <geometry>
        <cylinder radius="0.1" length="0.1"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
    </collision>

    <inertial>
      <mass value="1"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.01" iyy="0.01" izz="0.01"
               ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </link>
  
  <!-- Add surface properties for friction/grip -->
  <gazebo reference="left_wheel_link">
    <material>Gazebo/Grey</material>
    <surface>
      <friction>
        <ode>
          <!-- Friction coefficient (mu=1.0 is high friction) -->
          <mu>1.0</mu>
          <mu2>1.0</mu2>
        </ode>
      </friction>
    </surface>
  </gazebo>


  <!-- ========================= -->
  <!--     RIGHT WHEEL           -->
  <!-- ========================= -->
  <link name="right_wheel_link">
    <visual>
      <geometry>
        <cylinder radius="0.1" length="0.1"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <material name="black">
        <color rgba="0.1 0.1 0.1 1.0"/>
      </material>
    </visual>

    <collision>
      <geometry>
        <cylinder radius="0.1" length="0.1"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
    </collision>

    <inertial>
      <mass value="1"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.01" iyy="0.01" izz="0.01"
               ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </link>

  <!-- Add surface properties for friction/grip -->
  <gazebo reference="right_wheel_link">
    <material>Gazebo/Grey</material>
    <surface>
      <friction>
        <ode>
          <!-- Friction coefficient (mu=1.0 is high friction) -->
          <mu>1.0</mu>
          <mu2>1.0</mu2>
        </ode>
      </friction>
    </surface>
  </gazebo>


  <!-- ========================= -->
  <!--     LEFT WHEEL JOINT      -->
  <!-- ========================= -->
  <joint name="left_wheel_joint" type="revolute">
    <parent link="base_link"/>
    <child link="left_wheel_link"/>
    <origin xyz="0 0.3 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <!-- Increased effort limit for better movement -->
    <limit lower="-333.14" upper="333.14" effort="100" velocity="10"/>
  </joint>

  <!-- ========================= -->
  <!--     RIGHT WHEEL JOINT     -->
  <!-- ========================= -->
  <joint name="right_wheel_joint" type="revolute">
    <parent link="base_link"/>
    <child link="right_wheel_link"/>
    <origin xyz="0 -0.3 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <!-- Increased effort limit for better movement -->
    <limit lower="-333.14" upper="333.14" effort="100" velocity="10"/>
  </joint>


  <!-- ============================================== -->
  <!--  GAZEBO PLUGINS: Control, JointState, Sensors  -->
  <!-- ============================================== -->

  <!-- JOINT STATE PUBLISHER (Pulls wheel position from Gazebo to ROS for RViz) -->
  <gazebo>
    <plugin
        filename="gz-sim-joint-state-publisher-system"
        name="gz::sim::systems::JointStatePublisher">
        <topic>joint_states</topic>
        <joint_name>right_wheel_joint</joint_name>
        <joint_name>left_wheel_joint</joint_name>
    </plugin>
  </gazebo>

  <!-- JOINT CONTROLLERS (Applies angular velocity from ROS to Gazebo) -->
  <gazebo>
    <plugin
      filename="gz-sim-joint-controller-system"
      name="gz::sim::systems::JointController">
        <joint_name>left_wheel_joint</joint_name>
        <initial_velocity>0.0</initial_velocity>
        <topic>left_motor_rpm</topic> 
        <!-- FIX 2: Add PID gains to generate the necessary torque -->
        <p_gain>50000</p_gain>
        <i_gain>0.0</i_gain>
        <d_gain>10000</d_gain>
    </plugin>
  </gazebo>
  
  <gazebo>
    <plugin
      filename="gz-sim-joint-controller-system"
      name="gz::sim::systems::JointController">
        <joint_name>right_wheel_joint</joint_name>
        <initial_velocity>0.0</initial_velocity>
        <topic>right_motor_rpm</topic>
        <!-- FIX 2: Add PID gains to generate the necessary torque -->
        <p_gain>50000</p_gain>
        <i_gain>0.0</i_gain>
        <d_gain>10000</d_gain>
    </plugin>
  </gazebo>


  <!-- ========================= -->
  <!--         LIDAR LINK        -->
  <!-- ========================= -->

  <!-- Sensors system plugin (must be loaded once) -->
  <gazebo>
    <plugin
      filename="gz-sim-sensors-system"
      name="gz::sim::systems::Sensors">
      <render_engine>ogre2</render_engine>
    </plugin>
  </gazebo>
  
  <link name="rplidar_c1">
      <inertial>
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
        <mass value="0.4"/>
        <inertia ixx="1e-4" ixy="0.0" ixz="0.0" iyy="1e-4" iyz="0.0" izz="2e-4"/>
      </inertial>
      <visual name="">
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
        <geometry>
          <cylinder radius="0.05" length="0.02"/>
        </geometry>
        <material name="rplidar_c1">
          <color rgba="1.0 0.0 0.0 1.0"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
        <geometry>
          <cylinder radius="0.05" length="0.02"/>
        </geometry>
      </collision>
    </link>

    <joint name="rplidar_joint" type="fixed">
      <parent link="base_link"/>
      <child link="rplidar_c1"/>
      <origin xyz="0.0 0.0 0.4" rpy="0.0 0.0 0.0"/>
    </joint>

    <gazebo reference="rplidar_c1">
      <sensor type="gpu_lidar" name="rplidar_c1_sensor">
          <always_on>1</always_on>
          <visualize>true</visualize>
          <update_rate>20</update_rate>
          <topic>/gz_lidar/points</topic>
          <lidar>
              <scan>
                  <horizontal>
                      <samples>720</samples>
                      <resolution>1</resolution>
                      <min_angle>-3.14</min_angle>
                      <max_angle>3.14</max_angle>
                  </horizontal>
                  <vertical>
                      <samples>32</samples>
                      <resolution>1</resolution>
                      <min_angle>-0.5</min_angle>
                      <max_angle>0.5</max_angle>
                  </vertical>
              </scan>
              <range>
                  <min>0.8</min>
                  <max>60.0</max>
                  <resolution>0.01</resolution>
              </range>  
              <noise>
                  <type>gaussian</type>
                  <mean>0.0</mean>
                  <stddev>0.01</stddev>
              </noise>
          </lidar>
      </sensor>
  </gazebo> 



  <!-- ========================= -->
  <!--         IMU/ZED LINKS     -->
  <!-- ========================= -->
  <link name="zed_camera_link">
      <visual>
        <origin xyz="0 -0.1 0" rpy="0 0 1.5708"/>
        <geometry>
          <mesh filename="package://robot_description/src/meshes/zed.STL" scale="0.001 0.001 0.001"/>
        </geometry>
        <material name="zed_camera_link_gray">
          <color rgba="0.5 0.5 0.5 1.0"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0 -0.1 0" rpy="0 0 1.5708"/>
        <geometry>
          <mesh filename="package://robot_description/src/meshes/zed.STL" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="0.5"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <!-- FIX 1: Added missing 'iyz' attribute with value 0.0 -->
        <inertia ixx="1e-4" ixy="0.0" ixz="0.0" iyy="1e-4" iyz="0.0" izz="1e-4"/>
      </inertial>
    </link>

    <link name="zed_imu_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.02 0.02 0.02"/>
        </geometry>
        <material name="imu_frame">
          <color rgba="1.0 1.0 0.0 1.0"/>
        </material>
      </visual>
    </link>

    <link name="zed_left_optical_frame">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <sphere radius="0.01"/>
        </geometry>
        <material name="camera_frame">
          <color rgba="0.0 1.0 0.0 1.0"/>
        </material>
      </visual> 
    </link>

    <link name="zed_right_optical_frame">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <sphere radius="0.01"/>
        </geometry>
        <material name="camera_frame_right">
          <color rgba="0.0 0.0 1.0 1.0"/>
        </material>
      </visual> 
    </link>

      <gazebo reference="zed_imu_link">
          <sensor name="imu_sensor" type="imu">
              <always_on>1</always_on>
              <update_rate>100</update_rate>
              <visualize>true</visualize>
              <topic>/zed/zed_node/imu/data_raw</topic>
              <frame_id>zed_imu_link</frame_id> 
          </sensor>
      </gazebo>

    <gazebo>
          <plugin filename="libignition-gazebo-imu-system"
              name="ignition::gazebo::systems::Imu">
          </plugin>
    </gazebo>
    
    <joint name="zed_imu_joint" type="fixed">
      <parent link="zed_camera_link"/>
      <child link="zed_imu_link"/>
    <origin xyz="0 0 0.02" rpy="-0.17 0 0"/>
    </joint>
    
    <gazebo reference="zed_camera_link">
      <sensor name="zed2i_rgb" type="camera">
        <always_on>true</always_on>
        <visualize>true</visualize>
        <update_rate>60</update_rate>

        <camera name="zed2i_rgb">
          <horizontal_fov>1.02974</horizontal_fov>
          <image>
            <width>320</width>
            <height>240</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.02</near>
            <far>300</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.007</stddev>
          </noise>

          <camera_info>
            <width>320</width>
            <height>240</height>
            <K>700 0 960 0 700 540 0 0 1</K>
            <D>0 0 0 0 0</D>
            <distortion_model>plumb_bob</distortion_model>
          </camera_info>
          <camera_info_topic>/zed/zed_node/left/camera_info</camera_info_topic>
          <optical_frame_id>zed_left_optical_frame</optical_frame_id>
        </camera>
        <topic>/zed/zed_node/left/image_rect_color</topic>
      </sensor>

      <sensor name="zed2i_rgb_right" type="camera">
        <always_on>true</always_on>
        <visualize>true</visualize>
        <update_rate>60</update_rate>

        <camera name="zed2i_rgb_right">
          <horizontal_fov>1.02974</horizontal_fov>
          <image>
            <width>320</width>
            <height>240</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.02</near>
            <far>300</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.007</stddev>
          </noise>

          <camera_info>
            <width>320</width>
            <height>240</height>
            <K>700 0 960 0 700 540 0 0 1</K>
            <D>0 0 0 0 0</D>
            <distortion_model>plumb_bob</distortion_model>
          </camera_info>
          <camera_info_topic>/zed/zed_node/right/camera_info</camera_info_topic>
          <optical_frame_id>zed_right_optical_frame</optical_frame_id>
        </camera>
        <topic>/zed/zed_node/right/image_rect_color</topic>
      </sensor>

      <sensor name="zed2i_depth" type="depth">
        <always_on>true</always_on>
        <visualize>true</visualize>
        <update_rate>60</update_rate>
        <depth_camera name="zed2i_depth">
          <horizontal_fov>1.02974</horizontal_fov>
          <clip>
            <near>0.02</near>
            <far>40.0</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.001</stddev>
          </noise>
          <camera_info>
            <width>320</width>
            <height>240</height>
            <K>700 0 960 0 700 540 0 0 1</K>
            <D>0 0 0 0 0</D>
            <distortion_model>plumb_bob</distortion_model>
          </camera_info>
        </depth_camera>
        <topic>/zed/zed_node/depth/depth_registered</topic>
        <optical_frame_id>zed_left_optical_frame</optical_frame_id>
      </sensor>
    </gazebo>
    

    <joint name="zed_camera_joint" type="fixed">
      <parent link="base_link"/>
      <child link="zed_camera_link"/>
      <origin xyz="0.4 0.03 0.11" rpy="0 0 0"/>
    </joint>

    <joint name="zed_camera_optical_joint" type="fixed">
      <parent link="zed_camera_link"/>
      <child link="zed_left_optical_frame"/>
      <origin xyz="0.0 0.05 0.02" rpy="-1.5708 0 -1.5708"/>
    </joint>

    
    <joint name="zed_camera_right_optical_joint" type="fixed">
      <parent link="zed_camera_link"/>
      <child link="zed_right_optical_frame"/>
      <origin xyz="0 -0.05 0.02" rpy="-1.5708 3.1416 -1.5708"/>
    </joint>

</robot>